import 'package:dio/dio.dart';
import '../models/todo.dart';
import 'dio_client.dart';

class TodoService {
  final DioClient _dioClient;

  TodoService(this._dioClient);

  // âœ… ì„œë²„ ìš”ì²­ìš© ë°ì´í„° ë³€í™˜ (create/updateì— ì‚¬ìš©)
  Map<String, dynamic> _prepareTodoData(Todo todo) {
    return {
      'title': todo.title,
      if (todo.description.isNotEmpty) 'description': todo.description,
      'task_type': todo.taskType, // ì˜ˆ: "personal", "cow_specific", "farm_wide"
      'priority': todo.priority, // ì˜ˆ: "low", "medium", ...
      'category': todo.category, // ì˜ˆ: "milking", "feeding", ...
      'due_date': todo.dueDate.toIso8601String().split('T')[0], // "YYYY-MM-DD"
      if (todo.dueTime != null)
        'due_time':
            '${todo.dueTime!.hour.toString().padLeft(2, '0')}:${todo.dueTime!.minute.toString().padLeft(2, '0')}', // "HH:MM"
      'auto_generated': todo.autoGenerated,
      'recurrence': todo.recurrence ?? 'none', // ê¸°ë³¸ê°’ fallback
      if (todo.notes != null && todo.notes!.isNotEmpty) 'notes': todo.notes,
      'related_cow_id': todo.relatedCows.isNotEmpty
          ? todo.relatedCows.first
          : null, // ë‹¤ìˆ˜ â†’ ë‹¨ì¼ ID ë§¤í•‘
      'farm_id': todo.farmId,
      'owner_id': todo.ownerId,
    };
  }

  // âœ… ê³µí†µ ì‘ë‹µ íŒŒì„œ
  Todo _parseTodoResponse(dynamic data, {String context = 'Todo'}) {
    if (data is! Map<String, dynamic>) {
      throw Exception('Invalid response format in $context API');
    }
    return Todo.fromJson(data);
  }

  // âœ… ìƒì„±
  Future<Todo> createTodo(Todo todo) async {
    try {
      final response = await _dioClient.post('/api/todos/create',
          data: _prepareTodoData(todo));
      print('createTodo response: ${response.data}');
      return _parseTodoResponse(response.data, context: 'createTodo');
    } catch (e) {
      rethrow;
    }
  }

  // âœ… ì „ì²´ ëª©ë¡ ì¡°íšŒ
  Future<List<Todo>> getTodos({
    String? status,
    String? priority,
    String? category,
  }) async {
    try {
      final queryParams = <String, dynamic>{};
      if (status?.isNotEmpty ?? false)
        queryParams['status_filter'] = status!.toLowerCase();
      if (priority?.isNotEmpty ?? false)
        queryParams['priority_filter'] = priority!.toLowerCase();
      if (category?.isNotEmpty ?? false)
        queryParams['category_filter'] = category!.toLowerCase();

      final response =
          await _dioClient.get('/api/todos', queryParameters: queryParams);
      print('getTodos response: ${response.data}');
      if (response.data is! List) return [];
      return (response.data as List)
          .map((json) => Todo.fromJson(json as Map<String, dynamic>))
          .toList();
    } catch (e) {
      if (e is DioException) {
        print('âŒ DioError in getTodos(): ${e.type}');
        print('ğŸ“¥ Response data: ${e.response?.data}');
        print('ğŸ“¤ Status Code: ${e.response?.statusCode}');
      } else {
        print('âŒ Unknown error in getTodos(): $e');
      }
      rethrow;
    }
  }

  // âœ… ìƒì„¸ ì¡°íšŒ
  Future<Todo> getTodoById(String taskId) async {
    try {
      final response = await _dioClient.get('/api/todos/$taskId');
      return _parseTodoResponse(response.data, context: 'getTodoById');
    } catch (e) {
      rethrow;
    }
  }

  // âœ… ìˆ˜ì •
  Future<Todo> updateTodo(String taskId, Todo updatedTodo) async {
    try {
      final response = await _dioClient.put(
        '/api/todos/$taskId/update',
        data: _prepareTodoData(updatedTodo),
      );
      return _parseTodoResponse(response.data, context: 'updateTodo');
    } catch (e) {
      rethrow;
    }
  }

  // âœ… ì‚­ì œ
  Future<void> deleteTodo(String taskId) async {
    try {
      await _dioClient.delete('/api/todos/$taskId');
    } catch (e) {
      rethrow;
    }
  }

  // âœ… ì™„ë£Œ ì²˜ë¦¬
  Future<Todo> completeTodo(String taskId, {String? completionNotes}) async {
    try {
      final data = <String, dynamic>{};
      if (completionNotes != null) data['completion_notes'] = completionNotes;

      final response =
          await _dioClient.patch('/api/todos/$taskId/complete', data: data);
      return _parseTodoResponse(response.data, context: 'completeTodo');
    } catch (e) {
      rethrow;
    }
  }

  // âœ… ìƒíƒœ ë³€ê²½
  Future<Todo> updateTodoStatus(
    String taskId,
    String status, {
    String? completionNotes,
  }) async {
    try {
      final data = {
        'status': status.toLowerCase(),
        if (completionNotes != null) 'completion_notes': completionNotes,
      };
      final response =
          await _dioClient.patch('/api/todos/$taskId/status', data: data);
      return _parseTodoResponse(response.data, context: 'updateTodoStatus');
    } catch (e) {
      rethrow;
    }
  }

  // âœ… í†µê³„ ì¡°íšŒ
  Future<Map<String, dynamic>> getTodoStatistics() async {
    try {
      final response = await _dioClient.get('/api/todos/statistics');
      if (response.data is! Map<String, dynamic>) {
        throw Exception('Invalid response format in getTodoStatistics');
      }
      return response.data;
    } catch (e) {
      rethrow;
    }
  }

  // âœ… ìº˜ë¦°ë”ìš© í•  ì¼ ëª©ë¡
  Future<Map<DateTime, List<Todo>>> getCalendarTodos(
    DateTime startDate,
    DateTime endDate,
  ) async {
    try {
      final response = await _dioClient.get(
        '/api/todos/calendar',
        queryParameters: {
          'start_date': startDate.toIso8601String().split('T')[0],
          'end_date': endDate.toIso8601String().split('T')[0],
        },
      );

      final data = response.data;
      if (data is! Map<String, dynamic> ||
          data['dates'] is! Map<String, dynamic>) {
        throw Exception('Invalid calendar data format');
      }

      final result = <DateTime, List<Todo>>{};
      (data['dates'] as Map<String, dynamic>).forEach((key, value) {
        final date = DateTime.tryParse(key);
        if (date != null) {
          result[date] = (value as List)
              .map((json) => Todo.fromJson(json as Map<String, dynamic>))
              .toList();
        }
      });
      return result;
    } catch (e) {
      rethrow;
    }
  }
}
